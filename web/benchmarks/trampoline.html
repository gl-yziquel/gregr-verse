<p>Simple trampoline (with allocation): <span id="trampoline1">Computing ...</span></p>
<p>Simple loop: <span id="loop1">Computing ...</span></p>
<p>Comparison loop with continuation no-op: <span id="loop2">Computing ...</span></p>
<p>Comparison loop with continuation no-op and allocation: <span id="loop3">Computing ...</span></p>
<p>Optimized trampoline (without allocation): <span id="trampoline2">Computing ...</span></p>

<script>
function toZeroCPSAlloc(count) {
  if (count === 0) {
    return ['done', null];
  }
  return [toZeroCPSAlloc, count - 1];
}

function toZeroCPS(toZeroCPSResult, count) {
  if (count !== 0) {
    toZeroCPSResult[0] = toZeroCPS;
    toZeroCPSResult[1] = count - 1;
    return;
  }
  toZeroCPSResult[0] = 'done';
  toZeroCPSResult[1] = null;
}

function benchTrampolineAlloc(count) {
  var cont = toZeroCPSAlloc;
  var arg = count;
  while (arg !== null) {
    var result = cont(arg);
    cont = result[0];
    arg = result[1];
  }
  return cont;
}

function benchTrampoline(count) {
  var toZeroCPSResult = new Array(2)
  var cont = toZeroCPS;
  var args = count;
  while (args !== null) {
    cont(toZeroCPSResult, args);
    cont = toZeroCPSResult[0];
    args = toZeroCPSResult[1];
  }
  return cont;
}

function benchLoop(count) {
  while (count > 0) {
    count = count - 1;
  }
  return 'done';
}

function benchLoopNop1(count) {
  var toZeroCPSResult = new Array(2)
  var cont = toZeroCPS;
  var args = 10;
  while (count > 0) {
    toZeroCPS(toZeroCPSResult, args);
    cont = toZeroCPSResult[0];
    args = toZeroCPSResult[1] + 1;
    args = 10;
    count = count - 1;
  }
  return 'done';
}

function benchLoopNop2(count) {
  var irrelevant = [undefined];
  irrelevant.pop();
  var toZeroCPSResult = new Array(2)
  var cont = toZeroCPS;
  var args = 10;
  while (count > 0) {
    irrelevant.push(1);
    irrelevant.pop();
    toZeroCPS(toZeroCPSResult, args);
    cont = toZeroCPSResult[0];
    args = toZeroCPSResult[1] + 1;
    args = 10;
    count = count - 1;
  }
  return 'done';
}

function timed(f) {
  var start = Date.now();
  var result = f();
  var elapsed = Date.now() - start;
  return [result, elapsed];
}

function setResult(id, timeResult) {
  var result = timeResult[1].toString() + ' ms';
  document.getElementById(id).innerHTML = result;
}

function benchmark(id, f) {
  setResult(id, timed(function() { return f(10000000); }));
}

// ~125 ms
benchmark('trampoline1', benchTrampolineAlloc);
// ~11 ms
benchmark('loop1', benchLoop);
// ~35 ms
benchmark('loop2', benchLoopNop1);
// ~100 ms
benchmark('loop3', benchLoopNop2);
// ~35 ms
benchmark('trampoline2', benchTrampoline);
</script>
