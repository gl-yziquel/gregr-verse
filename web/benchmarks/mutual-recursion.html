<p>0 mod 3</p>
<table>
  <tr><td>initial</td><td id="initial">Computing ...</td></tr>
  <tr><td>trampoline</td><td id="trampoline">Computing ...</td></tr>
  <tr><td>simple loop</td><td id="simple">Computing ...</td></tr>
  <tr><td>greedy loop</td><td id="greedy">Computing ...</td></tr>
  <tr><td>greedy loop 2</td><td id="greedy2">Computing ...</td></tr>
  <tr><td>switch dispatching loop</td><td id="switch">Computing ...</td></tr>
  <tr><td>label dispatching loop</td><td id="label">Computing ...</td></tr>
  <tr><td>reduced label dispatching loop</td><td id="reducedlabel">Computing ...</td></tr>
</table>

<script>
function is0mod3(n) {
  if (n > 0) return is2mod3(n - 1);
  if (n < 0) return is1mod3(n + 1);
  return true;
}

function is1mod3(n) {
  if (n > 0) return is0mod3(n - 1);
  if (n < 0) return is2mod3(n + 1);
  return false;
}

function is2mod3(n) {
  if (n > 0) return is1mod3(n - 1);
  if (n < 0) return is0mod3(n + 1);
  return false;
}

var cpsResult = new Array(2);

function is0mod3CPS(n) {
  if (n > 0) {
    cpsResult[0] = is2mod3CPS;
    cpsResult[1] = n - 1;
  } else if (n < 0) {
    cpsResult[0] = is1mod3CPS;
    cpsResult[1] = n + 1;
  } else {
    cpsResult[0] = true;
    cpsResult[1] = null;
  }
}

function is1mod3CPS(n) {
  if (n > 0) {
    cpsResult[0] = is0mod3CPS;
    cpsResult[1] = n - 1;
  } else if (n < 0) {
    cpsResult[0] = is2mod3CPS;
    cpsResult[1] = n + 1;
  } else {
    cpsResult[0] = false;
    cpsResult[1] = null;
  }
}

function is2mod3CPS(n) {
  if (n > 0) {
    cpsResult[0] = is1mod3CPS;
    cpsResult[1] = n - 1;
  } else if (n < 0) {
    cpsResult[0] = is0mod3CPS;
    cpsResult[1] = n + 1;
  } else {
    cpsResult[0] = false;
    cpsResult[1] = null;
  }
}

function trampoline(n) {
  var cont = is0mod3CPS;
  var arg = n;
  while (arg !== null) {
    cont(arg);
    cont = cpsResult[0];
    arg = cpsResult[1];
  }
  return cont;
}

function switchDispatch(n) {
  var label = 0;
  while (true) {
    switch (label) {
      case 0: // 0 mod 3
        if (n > 0) {
          --n;
          label = 2;
        } else if (n < 0) {
          ++n;
          label = 1;
        } else { return true; }
        break;
      case 1: // 1 mod 3
        if (n > 0) {
          --n;
          label = 0;
        } else if (n < 0) {
          ++n;
          label = 2;
        } else { return false; }
        break;
      case 2: // 2 mod 3
        if (n > 0) {
          --n;
          label = 1;
        } else if (n < 0) {
          ++n;
          label = 0;
        } else { return false; }
        break;
    }
  }
}

function labelDispatch(n) {
  L_is0mod3:
  while (true) {
    if (n > 0) {
      --n;
      L_is2mod3:
      while (true) {
        if (n > 0) {
          --n;
          L_is1mod3:
          while (true) {
            if (n > 0) {
              --n;
              continue L_is0mod3;
            }
            if (n < 0) {
              ++n;
              continue L_is2mod3;
            }
            return false;
          }
        }
        if (n < 0) {
          --n;
          continue L_is0mod3;
        }
        return false;
      }
    }
    if (n < 0) {
      ++n;
      L_is1mod3:
      while (true) {
        if (n > 0) {
          --n;
          continue L_is0mod3;
        }
        if (n < 0) {
          ++n;
          L_is2mod3:
          while (true) {
            if (n > 0) {
              --n;
              continue L_is1mod3;
            }
            if (n < 0) {
              ++n;
              continue L_is0mod3;
            }
            return false;
          }
        }
        return false;
      }
    }
    return true;
  }
}

function reducedLabelDispatch(n) {
  L_is0mod3:
  while (true) {
    if (n > 0) {
      --n;
      L_is2mod3:
      while (true) {
        if (n > 0) {
          --n;
          L_is1mod3:
          while (true) {
            if (n > 0) {
              --n;
              continue L_is0mod3;
            }
            return false;
          }
        }
        return false;
      }
    }
    if (n < 0) {
      ++n;
      L_is1mod3:
      while (true) {
        if (n < 0) {
          ++n;
          L_is2mod3:
          while (true) {
            if (n < 0) {
              ++n;
              continue L_is0mod3;
            }
            return false;
          }
        }
        return false;
      }
    }
    return true;
  }
}

function loopSimple(n) {
  var result = 0;
  while (n !== 0) {
    n -= 1;
    result -= 1;
    if (result < 0) result = 2;
  }
  return result;
}

function loopGreedy(n) {
  while (true) {
    if (n === 0) return true;
    --n;
    if (n === 0) return false;
    --n;
    if (n === 0) return false;
    --n;
  }
}

function loopGreedy2(n) {
  while (true) {
    if (n > 0) {
      n -= 2;
    } else if (n < 0) return false;
    else return true;
  }
}

function timed(f) {
  var start = Date.now();
  var result = f();
  var elapsed = Date.now() - start;
  return [result, elapsed];
}

function setResult(id, result) {
  document.getElementById(id).innerHTML = result;
}

function benchmark(id, f) {
  var trialCount = 5;
  var trial = trialCount;
  var scores = new Array(trial);
  while (trial--) {
    scores[trial] = timed(function() { return f(10000000); })[1];
  }
  var sum = 0;
  var max = 0;
  var min = 1 << 30;
  var trial = trialCount;
  while (trial--) {
    score = scores[trial];
    sum += score;
    max = Math.max(max, score);
    min = Math.min(min, score);
  }
  var avg = sum / trialCount;
  result = 'total: ' + sum.toString() + ' ms; avg: ' + avg.toString() + ' ms; max: ' + max.toString() + ' ms; min: ' + min.toString() + ' ms';
  setResult(id, result);
}

// 540 - 720 ms
benchmark('trampoline', trampoline);
// ~102 ms
benchmark('simple', loopSimple);
// ~38 ms
benchmark('greedy', loopGreedy);
// ~27 ms
benchmark('greedy2', loopGreedy2);
// ~94 ms
benchmark('switch', switchDispatch);
// ~39 ms
benchmark('label', labelDispatch);
// ~29 ms
benchmark('reducedlabel', reducedLabelDispatch);
// stack overflow
//benchmark('initial', is0mod3);
</script>
